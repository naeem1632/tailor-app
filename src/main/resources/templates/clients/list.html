<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Clients - Stitch & Style</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>

<header class="site-header">
    <div class="logo-container">
        <!-- If you later have an image, use this: <img src="/images/logo.png" alt="Stitch & Style Logo" class="logo-img"> -->
        <span class="logo-text">Stitch & Style</span>
    </div>
</header>

<h1>All Clients</h1>

<div class="add-btn-container">
    <button class="add-btn" onclick="openModal()">Add Client</button>
</div>

<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Mobile</th>
        <th>WhatsApp</th>
        <th>Address</th>
        <th>Picture</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="c : ${clients}">
        <td th:text="${c.id}"></td>
        <td th:text="${c.name}"></td>
        <td th:text="${c.mobile}"></td>
        <td th:text="${c.whatsAppNo}"></td>
        <td th:text="${c.address}"></td>
        <td><img th:if="${c.pictureFilename}" th:src="@{${c.pictureFilename}}" alt="pic"/></td>
        <td>
            <a href="javascript:void(0)"
               class="btn-action btn-edit"
               th:attr="data-id=${c.id},
                  data-name=${c.name},
                  data-mobile=${c.mobile},
                  data-whatsapp=${c.whatsAppNo},
                  data-address=${c.address}"
               onclick="openModalFromRow(this)">Edit</a>
            <a th:href="@{'/payments/client/' + ${c.id}}" class="btn-action btn-payment">Payments</a>
            <a th:href="@{'/clients/view/' + ${c.id}}" class="btn-action btn-measure">Measurements</a>
        </td>
    </tr>
    </tbody>
</table>

<!-- âœ… MODAL (Styled Same as Payments) -->
<div id="clientModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle">Add Client</h3>

        <form class="client-form" th:action="@{/clients/save}" method="post" enctype="multipart/form-data">
            <input type="hidden" name="id" id="clientId"/>
            <input type="hidden" name="imageData" id="imageData"/>

            <table>
                <tr>
                    <th>Name</th><td><input type="text" name="name" id="name" required></td>
                    <th>Mobile #</th><td><input type="text" name="mobile" id="mobile" required></td>
                </tr>
                <tr>
                    <th>WhatsApp #</th><td><input type="text" name="whatsAppNo" id="whatsAppNo"></td>
                    <th>Address</th><td><input type="text" name="address" id="address" required></td>
                </tr>
                <tr>
                    <th>Picture</th>
                    <td colspan="3">
                        <input type="file" name="pictureFile" accept="image/*">
                        <button type="button" id="startCamBtn" style="margin-top:8px;">ðŸ“· Use Camera</button>
                        <div id="cameraContainer">
                            <video id="video" autoplay></video><br>
                            <button type="button" id="captureBtn">Capture</button>
                            <canvas id="canvas" style="display:none;"></canvas>
                        </div>
                    </td>
                </tr>
            </table>

            <div class="actions">
                <button type="submit">Save</button>
                <a href="javascript:void(0)" onclick="closeModal()">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
    const modal = document.getElementById("clientModal");
    const title = document.getElementById("modalTitle");

    function openModalFromRow(el) {
      openModal(el.dataset.id, el.dataset.name, el.dataset.mobile, el.dataset.whatsapp, el.dataset.address);
    }

    function openModal(id, name, mobile, whatsapp, address) {
      modal.classList.add("show");
      document.body.style.overflow = "hidden";
      title.innerText = id ? "Edit Client" : "Add Client";

      document.getElementById("clientId").value = id || "";
      document.getElementById("name").value = name || "";
      document.getElementById("mobile").value = mobile || "";
      document.getElementById("whatsAppNo").value = whatsapp || "";
      document.getElementById("address").value = address || "";
    }

    function closeModal() {
      modal.classList.remove("show");
      document.body.style.overflow = "auto";
    }

    // === Camera Logic ===
    const startCamBtn = document.getElementById('startCamBtn');
    const cameraContainer = document.getElementById('cameraContainer');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const imageData = document.getElementById('imageData');
    const captureBtn = document.getElementById('captureBtn');
    let stream = null;

    startCamBtn.addEventListener('click', async () => {
      cameraContainer.style.display = 'block';
      if (!stream) {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true });
          video.srcObject = stream;
        } catch (err) {
          alert('Error accessing camera: ' + err.message);
        }
      }
    });

    captureBtn.addEventListener('click', () => {
      const context = canvas.getContext('2d');
      canvas.style.display = 'block';
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/png');
      imageData.value = dataUrl;

      // Stop camera after capture
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      video.style.display = 'none';
    });
</script>

</body>
</html>
