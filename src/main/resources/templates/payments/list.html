<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Clients - Stitch & Style</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>

<body>

<header class="site-header">
    <div class="logo-container">
        <!-- If you later have an image, use this: <img src="/images/logo.png" alt="Stitch & Style Logo" class="logo-img"> -->
        <span class="logo-text">Stitch & Style</span>
    </div>
</header>

<h1 th:text="'Payments & Schedule for ' + ${client.name}"></h1>

<div class="toolbar-3">
    <div class="toolbar-left">
        <button class="add-btn" onclick="openModal()">Add Payment</button>
    </div>
    <div class="toolbar-center"></div>
    <div class="toolbar-right"></div>
</div>


<!-- ✅ PAYMENT LIST -->
<table>
    <thead>
    <tr>
        <th>Date</th>
        <th>Dress</th>
        <th>Waistcoat</th>
        <th>Total</th>
        <th>Paid</th>
        <th>Remaining</th>
        <th>Status</th>
        <th>Return Date</th>
        <th>Return Status</th>
        <th>Notes</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="p : ${payments}">
        <td th:text="${#temporals.format(p.date, 'dd-MMM-yyyy')}"></td>
        <td th:text="${p.dressCount + ' @ ' + p.dressRate}"></td>
        <td th:text="${p.waistcoatCount + ' @ ' + p.waistcoatRate}"></td>
        <td th:text="${p.totalAmount}"></td>
        <td th:text="${p.paidAmount}"></td>
        <td th:text="${p.remainingAmount}"></td>
        <td th:switch="${p.paymentStatus}">
            <span th:case="'Unpaid'" class="status-unpaid" th:text="${p.paymentStatus}"></span>
            <span th:case="'Partial'" class="status-partial" th:text="${p.paymentStatus}"></span>
            <span th:case="'Paid'" class="status-paid" th:text="${p.paymentStatus}"></span>
            <span th:case="*" th:text="${p.paymentStatus}"></span>
        </td>
        <td th:text="${p.returnDate != null ? #temporals.format(p.returnDate, 'dd-MMM-yyyy') : '-'}"></td>
        <td th:text="${p.returnStatus}"></td>
        <td th:text="${p.notes}"></td>
        <td>
            <a href="javascript:void(0)"
               class="btn-action btn-edit"
               th:attr="data-id=${p.id},
                  data-date=${p.date},
                  data-dresscount=${p.dressCount},
                  data-dressrate=${p.dressRate},
                  data-waistcoatcount=${p.waistcoatCount},
                  data-waistcoatrate=${p.waistcoatRate},
                  data-total=${p.totalAmount},
                  data-paid=${p.paidAmount},
                  data-remaining=${p.remainingAmount},
                  data-status=${p.paymentStatus},
                  data-returndate=${p.returnDate},
                  data-returnstatus=${p.returnStatus},
                  data-notes=${#strings.escapeJavaScript(p.notes != null ? p.notes : '')}"
               onclick="openModalFromRow(this)">Edit</a>
            <a th:href="@{'/payments/delete/' + ${p.id}}" style="color:#dc3545; font-weight:600;">Delete</a>
        </td>
    </tr>
    </tbody>
</table>

<!-- ✅ Go Back Button -->
<div class="go-back-container">
    <a th:href="@{/clients}" class="go-back-btn">Go Back Home</a>
</div>

<!-- ✅ MODAL POPUP -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle" style="text-align:center; color:#17a2b8; margin-bottom:15px;">Add Payment</h3>

        <form class="payment-form" th:action="@{/payments/save}" method="post">
            <input type="hidden" name="id" id="paymentId"/>
            <input type="hidden" name="client.id" th:value="${client.id}"/>

            <table>
                <tr>
                    <th>Date</th><td><input type="date" name="date" id="date" required/></td>
                    <th>Dress quantity</th><td><input type="number" name="dressCount" id="dressCount" required/></td>
                    <th>Dress rate</th><td><input type="number" name="dressRate" id="dressRate" required/></td>
                </tr>
                <tr>
                    <th>Waistcoat quantity</th><td><input type="number" name="waistcoatCount" id="waistcoatCount"/></td>
                    <th>Waistcoat rate</th><td><input type="number" name="waistcoatRate" id="waistcoatRate"/></td>
                    <th>Total</th><td><input type="number" name="totalAmount" id="totalAmount" readonly/></td>
                </tr>
                <tr>
                    <th>Paid</th><td><input type="number" name="paidAmount" id="paidAmount"/></td>
                    <th>Remaining</th><td><input type="number" name="remainingAmount" id="remainingAmount" readonly/></td>
                    <th>Payment status</th>
                    <td>
                        <select name="paymentStatus" id="paymentStatus">
                            <option value="Unpaid">Unpaid</option>
                            <option value="Partial">Partial</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Return date</th><td><input type="date" name="returnDate" id="returnDate" required/></td>
                    <th>Return status</th>
                    <td>
                        <select name="returnStatus" id="returnStatus">
                            <option value="Not yet">Not yet</option>
                            <option value="Returned">Returned</option>
                        </select>
                    </td>
                    <th>Notes</th><td colspan="3"><textarea name="notes" id="notes"></textarea></td>
                </tr>
            </table>

            <div class="actions">
                <button type="submit">Save</button>
                <a href="javascript:void(0)" onclick="closeModal()">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- ✅ Custom Delete Confirmation Modal -->
<div id="confirmDeleteModal" class="modal-overlay">
    <div class="modal-box">
        <h3>⚠ Confirm Deletion</h3>
        <p>Are you sure you want to delete this record?</p>
        <div class="modal-actions">
            <button id="confirmDeleteBtn" class="btn-danger">Yes, Delete</button>
            <button id="cancelDeleteBtn" class="btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<script>
    const modal = document.getElementById("paymentModal");
    const title = document.getElementById("modalTitle");

    function openModalFromRow(el) {
      openModal(
        el.dataset.id,
        el.dataset.date,
        el.dataset.dresscount,
        el.dataset.dressrate,
        el.dataset.waistcoatcount,
        el.dataset.waistcoatrate,
        el.dataset.total,
        el.dataset.paid,
        el.dataset.remaining,
        el.dataset.status,
        el.dataset.returndate,
        el.dataset.returnstatus,
        el.dataset.notes
      );
    }

    function openModal(id, date, dCount, dRate, wCount, wRate, total, paid, remaining, status, returnDate, returnStatus, notes) {
      modal.classList.add("show");
      document.body.style.overflow = "hidden";
      title.innerText = id ? "Edit Payment" : "Add Payment";

      document.getElementById("paymentId").value = id || "";
      document.getElementById("date").value = date || new Date().toISOString().split('T')[0];
      document.getElementById("dressCount").value = dCount || 0;
      document.getElementById("dressRate").value = dRate || 0;
      document.getElementById("waistcoatCount").value = wCount || 0;
      document.getElementById("waistcoatRate").value = wRate || 0;
      document.getElementById("totalAmount").value = total || 0;
      document.getElementById("paidAmount").value = paid || 0;
      document.getElementById("remainingAmount").value = remaining || 0;
      document.getElementById("paymentStatus").value = status || "Unpaid";
      document.getElementById("returnDate").value = (returnDate && returnDate !== "null") ? returnDate : "";
      document.getElementById("returnStatus").value = returnStatus || "Not yet";
      document.getElementById("notes").value = notes || "";
    }

    function closeModal() {
      modal.classList.remove("show");
      document.body.style.overflow = "auto";
    }

    // Auto calculate totals
    const dC = document.getElementById("dressCount");
    const dR = document.getElementById("dressRate");
    const wC = document.getElementById("waistcoatCount");
    const wR = document.getElementById("waistcoatRate");
    const tA = document.getElementById("totalAmount");
    const pA = document.getElementById("paidAmount");
    const rA = document.getElementById("remainingAmount");
    const sS = document.getElementById("paymentStatus");

    [dC, dR, wC, wR, pA].forEach(el => el.addEventListener("input", updateTotals));

    function updateTotals() {
      const total = (parseFloat(dC.value) || 0) * (parseFloat(dR.value) || 0)
                  + (parseFloat(wC.value) || 0) * (parseFloat(wR.value) || 0);
      const paid = parseFloat(pA.value) || 0;
      tA.value = total;
      rA.value = Math.max(total - paid, 0);
      sS.value = (rA.value == 0 && total > 0) ? "Paid" :
                 (paid > 0 && rA.value > 0) ? "Partial" : "Unpaid";
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
      let deleteUrl = null;
      const modal = document.getElementById("confirmDeleteModal");
      const confirmBtn = document.getElementById("confirmDeleteBtn");
      const cancelBtn = document.getElementById("cancelDeleteBtn");

      // Intercept all delete links
      document.querySelectorAll("a[href*='/payments/delete/']").forEach(link => {
        link.addEventListener("click", function (e) {
          e.preventDefault(); // stop immediate navigation
          deleteUrl = this.getAttribute("href");
          modal.style.display = "flex"; // show modal
        });
      });

      confirmBtn.addEventListener("click", function () {
        if (deleteUrl) {
          window.location.href = deleteUrl; // redirect to delete endpoint
        }
      });

      cancelBtn.addEventListener("click", function () {
        modal.style.display = "none";
        deleteUrl = null;
      });

      // Close modal when clicking outside box
      modal.addEventListener("click", function (e) {
        if (e.target === modal) {
          modal.style.display = "none";
          deleteUrl = null;
        }
      });
    });
</script>

</body>
</html>
