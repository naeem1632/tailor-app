<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Client Payments</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>

<h1 th:text="'Payments & Schedule for ' + ${client.name}"></h1>

<div class="add-btn-container">
    <button class="add-btn" onclick="openModal()">Add Payment</button>
</div>

<!-- âœ… PAYMENT LIST -->
<table>
    <thead>
    <tr>
        <th>Date</th>
        <th>Dress</th>
        <th>Waistcoat</th>
        <th>Total</th>
        <th>Paid</th>
        <th>Remaining</th>
        <th>Status</th>
        <th>Return Date</th>
        <th>Return Status</th>
        <th>Notes</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="p : ${payments}">
        <td th:text="${#temporals.format(p.date, 'dd-MMM-yyyy')}"></td>
        <td th:text="${p.dressCount + ' @ ' + p.dressRate}"></td>
        <td th:text="${p.waistcoatCount + ' @ ' + p.waistcoatRate}"></td>
        <td th:text="${p.totalAmount}"></td>
        <td th:text="${p.paidAmount}"></td>
        <td th:text="${p.remainingAmount}"></td>
        <td th:switch="${p.paymentStatus}">
            <span th:case="'Unpaid'" class="status-unpaid" th:text="${p.paymentStatus}"></span>
            <span th:case="'Partial'" class="status-partial" th:text="${p.paymentStatus}"></span>
            <span th:case="'Paid'" class="status-paid" th:text="${p.paymentStatus}"></span>
            <span th:case="*" th:text="${p.paymentStatus}"></span>
        </td>
        <td th:text="${p.returnDate != null ? #temporals.format(p.returnDate, 'dd-MMM-yyyy') : '-'}"></td>
        <td th:text="${p.returnStatus}"></td>
        <td th:text="${p.notes}"></td>
        <td>
            <a href="javascript:void(0)"
               class="btn-action btn-edit"
               th:attr="data-id=${p.id},
                  data-date=${p.date},
                  data-dresscount=${p.dressCount},
                  data-dressrate=${p.dressRate},
                  data-waistcoatcount=${p.waistcoatCount},
                  data-waistcoatrate=${p.waistcoatRate},
                  data-total=${p.totalAmount},
                  data-paid=${p.paidAmount},
                  data-remaining=${p.remainingAmount},
                  data-status=${p.paymentStatus},
                  data-returndate=${p.returnDate},
                  data-returnstatus=${p.returnStatus},
                  data-notes=${#strings.escapeJavaScript(p.notes != null ? p.notes : '')}"
               onclick="openModalFromRow(this)">Edit</a>
            <a th:href="@{'/payments/delete/' + ${p.id}}"
               class="btn-action btn-delete"
               onclick="return confirm('Delete this payment?')">Delete</a>
        </td>
    </tr>
    </tbody>
</table>

<!-- âœ… Go Back Button -->
<div class="go-back-container">
    <a th:href="@{/clients}" class="go-back-btn">Go Back Home</a>
</div>

<!-- âœ… MODAL POPUP -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle" style="text-align:center; color:#17a2b8; margin-bottom:15px;">Add Payment</h3>

        <form class="payment-form" th:action="@{/payments/save}" method="post">
            <input type="hidden" name="id" id="paymentId"/>
            <input type="hidden" name="client.id" th:value="${client.id}"/>

            <table>
                <tr>
                    <th>Date</th><td><input type="date" name="date" id="date" required/></td>
                    <th>Dress Count</th><td><input type="number" name="dressCount" id="dressCount"/></td>
                    <th>Dress Rate</th><td><input type="number" name="dressRate" id="dressRate"/></td>
                </tr>
                <tr>
                    <th>Waistcoat Count</th><td><input type="number" name="waistcoatCount" id="waistcoatCount"/></td>
                    <th>Waistcoat Rate</th><td><input type="number" name="waistcoatRate" id="waistcoatRate"/></td>
                    <th>Total</th><td><input type="number" name="totalAmount" id="totalAmount" readonly/></td>
                </tr>
                <tr>
                    <th>Paid</th><td><input type="number" name="paidAmount" id="paidAmount"/></td>
                    <th>Remaining</th><td><input type="number" name="remainingAmount" id="remainingAmount" readonly/></td>
                    <th>Status</th>
                    <td>
                        <select name="paymentStatus" id="paymentStatus">
                            <option value="Unpaid">Unpaid</option>
                            <option value="Partial">Partial</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Return Date</th><td><input type="date" name="returnDate" id="returnDate"/></td>
                    <th>Return Status</th>
                    <td>
                        <select name="returnStatus" id="returnStatus">
                            <option value="Not yet">Not yet</option>
                            <option value="Returned">Returned</option>
                        </select>
                    </td>
                    <th>Notes</th><td colspan="3"><textarea name="notes" id="notes"></textarea></td>
                </tr>
            </table>

            <div class="actions">
                <button type="submit">ðŸ’¾ Save</button>
                <a href="javascript:void(0)" onclick="closeModal()">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
    const modal = document.getElementById("paymentModal");
    const title = document.getElementById("modalTitle");

    function openModalFromRow(el) {
      openModal(
        el.dataset.id,
        el.dataset.date,
        el.dataset.dresscount,
        el.dataset.dressrate,
        el.dataset.waistcoatcount,
        el.dataset.waistcoatrate,
        el.dataset.total,
        el.dataset.paid,
        el.dataset.remaining,
        el.dataset.status,
        el.dataset.returndate,
        el.dataset.returnstatus,
        el.dataset.notes
      );
    }

    function openModal(id, date, dCount, dRate, wCount, wRate, total, paid, remaining, status, returnDate, returnStatus, notes) {
      modal.classList.add("show");
      document.body.style.overflow = "hidden";
      title.innerText = id ? "Edit Payment" : "Add Payment";

      document.getElementById("paymentId").value = id || "";
      document.getElementById("date").value = date || new Date().toISOString().split('T')[0];
      document.getElementById("dressCount").value = dCount || 0;
      document.getElementById("dressRate").value = dRate || 0;
      document.getElementById("waistcoatCount").value = wCount || 0;
      document.getElementById("waistcoatRate").value = wRate || 0;
      document.getElementById("totalAmount").value = total || 0;
      document.getElementById("paidAmount").value = paid || 0;
      document.getElementById("remainingAmount").value = remaining || 0;
      document.getElementById("paymentStatus").value = status || "Unpaid";
      document.getElementById("returnDate").value = (returnDate && returnDate !== "null") ? returnDate : "";
      document.getElementById("returnStatus").value = returnStatus || "Not yet";
      document.getElementById("notes").value = notes || "";
    }

    function closeModal() {
      modal.classList.remove("show");
      document.body.style.overflow = "auto";
    }

    // Auto calculate totals
    const dC = document.getElementById("dressCount");
    const dR = document.getElementById("dressRate");
    const wC = document.getElementById("waistcoatCount");
    const wR = document.getElementById("waistcoatRate");
    const tA = document.getElementById("totalAmount");
    const pA = document.getElementById("paidAmount");
    const rA = document.getElementById("remainingAmount");
    const sS = document.getElementById("paymentStatus");

    [dC, dR, wC, wR, pA].forEach(el => el.addEventListener("input", updateTotals));

    function updateTotals() {
      const total = (parseFloat(dC.value) || 0) * (parseFloat(dR.value) || 0)
                  + (parseFloat(wC.value) || 0) * (parseFloat(wR.value) || 0);
      const paid = parseFloat(pA.value) || 0;
      tA.value = total;
      rA.value = Math.max(total - paid, 0);
      sS.value = (rA.value == 0 && total > 0) ? "Paid" :
                 (paid > 0 && rA.value > 0) ? "Partial" : "Unpaid";
    }
</script>

</body>
</html>
