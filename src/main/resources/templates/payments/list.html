<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Client Payments - Stitch & Style</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <!-- Master stylesheet -->
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>

<body>
<header class="site-header">
    <div class="logo-container">
        <span class="logo-text">Stitch & Style</span>
    </div>
</header>

<h1 th:text="'Payments & Schedule for ' + ${client.name}"></h1>

<div class="toolbar-3">
    <div class="toolbar-left">
        <button class="add-btn" onclick="openModal()">Add Payment</button>
    </div>
</div>

<!-- ✅ PAYMENT LIST -->
<table>
    <thead>
    <tr>
        <th></th>
        <th>Date</th>
        <th>Dress</th>
        <th>Waistcoat</th>
        <th>Total</th>
        <th>Total Paid</th>
        <th>Remaining</th>
        <th>Status</th>
        <th>Return Date</th>
        <th>Return Status</th>
        <th>Notes</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <th:block th:each="p : ${payments}">
        <tr>
            <td>
                <button class="expand-btn" type="button"
                        th:attr="onclick='toggleInstallments(' + ${p.id} + ')'">▼</button>
            </td>
            <td th:text="${#temporals.format(p.date, 'dd-MMM-yyyy')}"></td>
            <td th:text="${(p.dressCount != null or p.dressRate != null)
                ? p.dressCount + ' @ ' + p.dressRate
                : ''}"></td>

            <td th:text="${(p.waistcoatCount != null or p.waistcoatRate != null)
                ? p.waistcoatCount + ' @ ' + p.waistcoatRate
                : ''}"></td>
            <td th:text="${p.totalAmount}"></td>
            <td th:text="${p.paidAmount}"></td>
            <td th:text="${p.remainingAmount}"></td>
            <td th:text="${p.paymentStatus}"
                th:style="${p.paymentStatus == 'Paid' ? 'color:green;' :
                          (p.paymentStatus == 'Partial' ? 'color:orange;' : 'color:red;')}"></td>
            <td th:text="${p.returnDate != null ? #temporals.format(p.returnDate, 'dd-MMM-yyyy') : '-'}"></td>
            <td th:text="${p.returnStatus}"></td>
            <td th:text="${p.notes}"></td>
            <td>
                <a href="javascript:void(0)" class="btn-action btn-edit"
                   th:attr="data-id=${p.id}, data-date=${p.date},
                            data-dresscount=${p.dressCount}, data-dressrate=${p.dressRate},
                            data-waistcoatcount=${p.waistcoatCount}, data-waistcoatrate=${p.waistcoatRate},
                            data-total=${p.totalAmount}, data-remaining=${p.remainingAmount},
                            data-status=${p.paymentStatus}, data-returndate=${p.returnDate},
                            data-returnstatus=${p.returnStatus}, data-notes=${p.notes}"
                   onclick="openModalFromRow(this)">Edit</a>

                <a th:href="@{'/payments/delete/' + ${p.id}}" class="btn-action btn-delete">Delete</a>

                <a href="javascript:void(0)" class="btn-action btn-payment"
                   th:attr="data-id=${p.id}"
                   onclick="openInstallmentModal(this)">Add Installment</a>
            </td>
        </tr>

        <!-- ✅ Installments Table -->
        <tr th:id="'installments-' + ${p.id}" class="installment-row" style="display:none;">
            <td colspan="12">
                <table class="installments-table">
                    <thead>
                    <tr><th>Date</th><th>Paid Amount</th><th>Note</th></tr>
                    </thead>
                    <tbody>
                    <tr th:each="i : ${p.installments}">
                        <td th:text="${#temporals.format(i.paymentDate, 'dd-MMM-yyyy')}"></td>
                        <td th:text="${i.paidAmount}"></td>
                        <td th:text="${i.note}"></td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(p.installments)}">
                        <td colspan="3" style="text-align:center; color:gray;">No installments yet</td>
                    </tr>
                    </tbody>
                </table>
            </td>
        </tr>
    </th:block>
    </tbody>
</table>

<!-- ✅ Go Back Button -->
<div class="go-back-container">
    <a th:href="@{/clients}" class="go-back-btn">Go Back Home</a>
</div>

<!-- ✅ ADD/EDIT PAYMENT MODAL -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle">Add Payment</h3>

        <form th:action="@{/payments/save}" method="post" class="payment-form">
            <input type="hidden" name="id" id="paymentId"/>
            <input type="hidden" name="client.id" th:value="${client.id}"/>

            <table>
                <tr>
                    <th>Date</th><td><input type="date" name="date" id="date" required/></td>
                    <th>Dress Qty</th><td><input type="number" name="dressCount" id="dressCount" required/></td>
                    <th>Dress Rate</th><td><input type="number" name="dressRate" id="dressRate" required/></td>
                </tr>
                <tr>
                    <th>Waistcoat Qty</th><td><input type="number" name="waistcoatCount" id="waistcoatCount"/></td>
                    <th>Waistcoat Rate</th><td><input type="number" name="waistcoatRate" id="waistcoatRate"/></td>
                    <th>Total</th><td><input type="number" name="totalAmount" id="totalAmount" readonly/></td>
                </tr>
                <tr>
                    <th>Remaining</th><td><input type="number" name="remainingAmount" id="remainingAmount" readonly/></td>
                    <th>Status</th>
                    <td>
                        <select name="paymentStatus" id="paymentStatus">
                            <option value="Unpaid">Unpaid</option>
                            <option value="Partial">Partial</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Return Date</th><td><input type="date" name="returnDate" id="returnDate" required/></td>
                    <th>Return Status</th>
                    <td>
                        <select name="returnStatus" id="returnStatus">
                            <option value="Not yet">Not yet</option>
                            <option value="Returned">Returned</option>
                        </select>
                    </td>
                    <th>Notes</th><td colspan="3"><textarea name="notes" id="notes"></textarea></td>
                </tr>
            </table>

            <div class="actions">
                <button type="submit">Save</button>
                <a href="javascript:void(0)" onclick="closeModal()">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- ✅ INSTALLMENT MODAL -->
<div id="installmentModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeInstallmentModal()">&times;</span>
        <h3>Add Payment Installment</h3>

        <form th:action="@{/payments/installment/add}" method="post">
            <input type="hidden" name="paymentId" id="installmentPaymentId"/>
            <table>
                <tr><th>Date</th><td><input type="date" name="paymentDate" id="installmentDate" required/></td></tr>
                <tr><th>Paid Amount</th><td><input type="number" name="paidAmount" id="installmentPaidAmount" required/></td></tr>
                <tr><th>Note</th><td><input type="text" name="note" id="installmentNote"/></td></tr>
            </table>
            <div class="actions">
                <button type="submit">Add Payment</button>
                <a href="javascript:void(0)" onclick="closeInstallmentModal()">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- ✅ JS LOGIC -->
<script>
    function toggleInstallments(paymentId) {
       const row = document.getElementById("installments-" + paymentId);
       const btn = document.querySelector(`[onclick*="toggleInstallments(${paymentId})"]`);
       if (row.style.display === "none" || row.style.display === "") {
           row.style.display = "table-row";
           if (btn) btn.textContent = "▲";
       } else {
           row.style.display = "none";
           if (btn) btn.textContent = "▼";
       }
   }

        const paymentModal = document.getElementById("paymentModal");
        const installmentModal = document.getElementById("installmentModal");

        function openModal() {
            paymentModal.classList.add("show");
            document.body.style.overflow = "hidden";
            document.getElementById("modalTitle").innerText = "Add Payment";
            clearPaymentForm();
        }

        function closeModal() {
            paymentModal.classList.remove("show");
            document.body.style.overflow = "auto";
        }

        function openModalFromRow(el) {
            openModal();
            document.getElementById("modalTitle").innerText = "Edit Payment";
            document.getElementById("paymentId").value = el.dataset.id;
            document.getElementById("date").value = el.dataset.date;
            document.getElementById("dressCount").value = el.dataset.dresscount;
            document.getElementById("dressRate").value = el.dataset.dressrate;
            document.getElementById("waistcoatCount").value = el.dataset.waistcoatcount;
            document.getElementById("waistcoatRate").value = el.dataset.waistcoatrate;
            document.getElementById("totalAmount").value = el.dataset.total;
            document.getElementById("remainingAmount").value = el.dataset.remaining;
            document.getElementById("paymentStatus").value = el.dataset.status;
            document.getElementById("returnDate").value = el.dataset.returndate;
            document.getElementById("returnStatus").value = el.dataset.returnstatus;
            document.getElementById("notes").value = el.dataset.notes;
        }

        function clearPaymentForm() {
            document.getElementById("paymentId").value = "";
            document.querySelector(".payment-form").reset();
            document.getElementById("totalAmount").value = "";
            document.getElementById("remainingAmount").value = "";
        }

        function openInstallmentModal(el) {
            installmentModal.classList.add("show");
            document.body.style.overflow = "hidden";
            document.getElementById("installmentPaymentId").value = el.dataset.id;
            document.getElementById("installmentDate").value = new Date().toISOString().split('T')[0];
        }

        function closeInstallmentModal() {
            installmentModal.classList.remove("show");
            document.body.style.overflow = "auto";
        }

        // ✅ Auto-calc total and remaining when qty/rate changes
        const dressCount = document.getElementById("dressCount");
        const dressRate = document.getElementById("dressRate");
        const waistcoatCount = document.getElementById("waistcoatCount");
        const waistcoatRate = document.getElementById("waistcoatRate");

        function calculateTotals() {
            const dCount = parseFloat(dressCount.value) || 0;
            const dRate = parseFloat(dressRate.value) || 0;
            const wCount = parseFloat(waistcoatCount.value) || 0;
            const wRate = parseFloat(waistcoatRate.value) || 0;

            const total = (dCount * dRate) + (wCount * wRate);
            document.getElementById("totalAmount").value = total;
            document.getElementById("remainingAmount").value = total;
        }

        [dressCount, dressRate, waistcoatCount, waistcoatRate].forEach(el => {
            el.addEventListener("input", calculateTotals);
        });
</script>

</body>
</html>
